<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Orders - Seller Dashboard</title>
  
  <link rel="stylesheet" href="css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      min-height: 100vh;
    }

    .seller-header {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(74, 222, 128, 0.2);
    }

    .seller-header .logo {
      color: #4ade80;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .seller-header .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: #fff;
    }

    .back-to-dashboard {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      padding: 0.5rem 1.5rem;
      color: #4ade80;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .back-to-dashboard:hover {
      background: rgba(74, 222, 128, 0.2);
      border-color: #4ade80;
      color: #4ade80;
    }

    .page-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .page-header {
      background: rgba(74, 222, 128, 0.1);
      padding: 2rem;
      border-radius: 25px;
      border: 1px solid rgba(74, 222, 128, 0.3);
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }

    .page-title {
      color: #4ade80;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: rgba(12, 11, 11, 0.8);
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.15);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 800;
      color: #4ade80;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: rgba(14, 13, 13, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .table-card {
      background: rgba(74, 222, 128, 0.05);
      border: 1px solid rgba(74, 222, 128, 0.2);
      border-radius: 20px;
      padding: 2rem;
      backdrop-filter: blur(10px);
    }

    table.dataTable {
      border-collapse: separate !important;
      border-spacing: 0;
      color: white !important;
    }

    table.dataTable thead th {
      background: linear-gradient(135deg, #16a34a, #22c55e) !important;
      color: white !important;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.85rem;
      padding: 1.2rem 1rem !important;
      border: none !important;
    }

    table.dataTable thead th:first-child {
      border-top-left-radius: 12px;
    }

    table.dataTable thead th:last-child {
      border-top-right-radius: 12px;
    }

    table.dataTable tbody td {
      padding: 1.2rem 1rem !important;
      vertical-align: middle;
      border-bottom: 1px solid rgba(74, 222, 128, 0.1) !important;
      color: rgba(15, 13, 13, 0.9) !important;
    }

    table.dataTable tbody tr {
      transition: background-color 0.2s;
    }

    table.dataTable tbody tr:hover {
      background-color: rgba(74, 222, 128, 0.1) !important;
    }

    .status-badge {
      padding: 0.4rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block;
    }

    .status-pending {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: rgb(1, 1, 1);
    }

    .status-shipped {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: rgb(17, 13, 13);
    }

    .status-received {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: rgb(7, 6, 6);
    }

    .status-cancelled {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: rgb(10, 9, 9);
    }

    .action-btn {
      padding: 0.5rem 1.2rem;
      border: none;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .modal-content {
      background: rgba(15, 32, 39, 0.95);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .modal-header {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      border-radius: 20px 20px 0 0;
      padding: 1.5rem;
      border: none;
    }

    .modal-body {
      padding: 2rem;
      color: white;
    }

    .order-details {
      background: rgba(74, 222, 128, 0.05);
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 1.5rem;
    }

    .order-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(74, 222, 128, 0.1);
    }

    .order-detail-row:last-child {
      border-bottom: none;
    }

    .order-detail-label {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
    }

    .order-detail-value {
      color: #4ade80;
      font-weight: 600;
    }

    /* üéüÔ∏è Discount Badge Styling */
    .discount-badge {
      display: inline-block;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-left: 0.5rem;
    }

    .discount-section {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
    }

    .product-item {
      background: rgba(74, 222, 128, 0.05);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border: 1px solid rgba(74, 222, 128, 0.2);
    }

    .form-select, .form-control {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: white;
      border-radius: 10px;
      padding: 0.75rem;
    }

    .form-select:focus, .form-control:focus {
      background: rgba(74, 222, 128, 0.15);
      border-color: #4ade80;
      color: white;
      box-shadow: 0 0 0 0.2rem rgba(74, 222, 128, 0.25);
    }

    .form-select option {
      background: #1a1a1a;
      color: white;
    }

    .btn-update {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      color: white;
      transition: all 0.3s;
    }

    .btn-update:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(22, 163, 74, 0.4);
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
      color: white !important;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: white;
      border-radius: 10px;
      padding: 0.5rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
      color: white !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: linear-gradient(135deg, #16a34a, #22c55e) !important;
      border: none !important;
      color: white !important;
      border-radius: 8px !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
      background: rgba(74, 222, 128, 0.2) !important;
      border: none !important;
      color: white !important;
    }

    @media (max-width: 768px) {
      .seller-header {
        flex-direction: column;
        gap: 1rem;
      }

      .page-container {
        padding: 0 1rem;
      }

      .table-card {
        padding: 1rem;
        overflow-x: auto;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="seller-header">
    <div class="logo">UniTree - Seller Portal</div>
    <div class="user-info">
      <a href="seller.html" class="back-to-dashboard">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </div>

  <div class="page-container">
    <div class="page-header">
      <h1 class="page-title">Manage Orders</h1>
      <p class="page-subtitle">View and manage orders for your products</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-number" id="totalOrders">0</div>
        <div class="stat-label">Total Orders</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-number" id="pendingOrders">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöö</div>
        <div class="stat-number" id="shippedOrders">0</div>
        <div class="stat-label">Shipped</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-number" id="completedOrders">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>

    <div class="table-card">
      <table id="sellerOrdersTable" class="table table-striped">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Status</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Update Status Modal -->
  <div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Order Status</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="order-details" id="orderDetailsSection"></div>
          
          <div class="mb-3">
            <label class="form-label">Update Status</label>
            <select class="form-select" id="statusSelect">
              <option value="pending">Pending</option>
              <option value="shipped">Shipped</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes about this status update..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-update" id="confirmUpdateBtn">Update Status</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/config.js"></script>
  <script src="js/user.js"></script>

  <script>
    let currentOrderId = null;
    let ordersTable = null;

    $(document).ready(function() {
      const token = sessionStorage.getItem('access_token');
      const sellerId = sessionStorage.getItem('userId');
      const userRole = sessionStorage.getItem('role');

      if (!token || userRole !== 'seller') {
        Swal.fire({
          icon: 'error',
          title: 'Access Denied',
          text: 'You must be logged in as a seller to access this page.',
          confirmButtonColor: '#4ade80'
        }).then(() => {
          window.location.href = 'login.html';
        });
        return;
      }

      ordersTable = $('#sellerOrdersTable').DataTable({
        ajax: {
          url: `${url}api/v1/seller/${sellerId}/orders`,
          headers: {
            'Authorization': `Bearer ${token}`
          },
          dataSrc: function(response) {
            console.log('Orders API Response:', response);
            if (response.success && response.orders) {
              updateStats(response.orders);
              return response.orders;
            }
            return [];
          },
          error: function(xhr) {
            console.error('Error loading orders:', xhr);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: xhr.responseJSON?.error || 'Failed to load orders. Please try again.',
              confirmButtonColor: '#4ade80'
            });
          }
        },
        columns: [
          { data: 'order_id' },
          { 
            data: null,
            render: function(data) {
              return data.username || data.email || 'N/A';
            }
          },
          { 
            data: null,
            render: function(data) {
              let productName = data.name || data.product_name || 'N/A';
              // üéüÔ∏è Add discount badge if present
              if (data.discount_code) {
                productName += ` <span class="discount-badge"><i class="fas fa-tag"></i> ${data.discount_code}</span>`;
              }
              return productName;
            }
          },
          { data: 'quantity' },
          { 
            data: null,
            render: function(data) {
              const itemTotal = parseFloat(data.price || 0) * parseInt(data.quantity || 0);
              return '‚Ç±' + itemTotal.toLocaleString('en-PH', {minimumFractionDigits: 2});
            }
          },
          {
            data: 'status',
            render: function(data) {
              const statusClasses = {
                'pending': 'status-pending',
                'shipped': 'status-shipped',
                'received': 'status-received',
                'cancelled': 'status-cancelled'
              };
              return `<span class="status-badge ${statusClasses[data]}">${data}</span>`;
            }
          },
          {
            data: 'date_placed',
            render: function(data) {
              return new Date(data).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
            }
          },
          {
            data: null,
            render: function(data) {
              if (data.status === 'pending') {
                return `<button class="action-btn update-status-btn" data-order-id="${data.order_id}" data-order-item-id="${data.order_item_id}">
                  <i class="fas fa-truck"></i> Ship Order
                </button>`;
              } else if (data.status === 'shipped') {
                return `<button class="action-btn update-status-btn" data-order-id="${data.order_id}" data-order-item-id="${data.order_item_id}">
                  <i class="fas fa-edit"></i> Update Status
                </button>`;
              } else {
                return `<button class="action-btn" disabled>
                  <i class="fas fa-check"></i> ${data.status}
                </button>`;
              }
            }
          }
        ],
        order: [[6, 'desc']],
        pageLength: 10,
        responsive: true
      });

      $('#sellerOrdersTable').on('click', '.update-status-btn', function() {
        const orderId = $(this).data('order-id');
        const rowData = ordersTable.row($(this).parents('tr')).data();
        
        currentOrderId = orderId;
        showUpdateModal(rowData);
      });

      $('#confirmUpdateBtn').click(function() {
        updateOrderStatus();
      });
    });

    function showUpdateModal(orderData) {
      const itemTotal = parseFloat(orderData.price || 0) * parseInt(orderData.quantity || 0);
      
      // üéüÔ∏è Build discount section if discount exists
      let discountSection = '';
      if (orderData.discount_code || orderData.discount_percent) {
        const discountAmount = itemTotal * (parseFloat(orderData.discount_percent || 0) / 100);
        const finalTotal = itemTotal - discountAmount;
        
        discountSection = `
          <div class="discount-section">
            <div style="display:flex; align-items:center; margin-bottom:0.5rem;">
              <i class="fas fa-ticket" style="color:#fbbf24; margin-right:0.5rem;"></i>
              <strong style="color:#fbbf24;">Discount Applied</strong>
            </div>
            <div class="order-detail-row">
              <span class="order-detail-label">Discount Code:</span>
              <span class="order-detail-value">${orderData.discount_code || 'N/A'}</span>
            </div>
            <div class="order-detail-row">
              <span class="order-detail-label">Discount Rate:</span>
              <span class="order-detail-value">${orderData.discount_percent}%</span>
            </div>
            <div class="order-detail-row">
              <span class="order-detail-label">Discount Amount:</span>
              <span class="order-detail-value" style="color:#fbbf24;">-‚Ç±${discountAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
            </div>
            <div class="order-detail-row">
              <span class="order-detail-label">Final Total:</span>
              <span class="order-detail-value" style="font-size:1.2em;">‚Ç±${finalTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
            </div>
          </div>
        `;
      }
      
      const detailsHtml = `
        <div class="order-detail-row">
          <span class="order-detail-label">Order ID:</span>
          <span class="order-detail-value">#${orderData.order_id}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Customer:</span>
          <span class="order-detail-value">${orderData.username || orderData.email || 'N/A'}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Product:</span>
          <span class="order-detail-value">${orderData.name || orderData.product_name || 'N/A'}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Quantity:</span>
          <span class="order-detail-value">${orderData.quantity}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Unit Price:</span>
          <span class="order-detail-value">‚Ç±${parseFloat(orderData.price || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label">Subtotal:</span>
          <span class="order-detail-value">‚Ç±${itemTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
        </div>
        ${discountSection}
        <div class="order-detail-row">
          <span class="order-detail-label">Current Status:</span>
          <span class="order-detail-value">${orderData.status}</span>
        </div>
      `;
      
      $('#orderDetailsSection').html(detailsHtml);
      $('#statusSelect').val(orderData.status);
      $('#statusNotes').val('');
      
      const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
      modal.show();
    }

    function updateOrderStatus() {
      const newStatus = $('#statusSelect').val();
      const notes = $('#statusNotes').val();
      const token = sessionStorage.getItem('access_token');

      if (!currentOrderId) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Order ID not found',
          confirmButtonColor: '#4ade80'
        });
        return;
      }

      $('#confirmUpdateBtn').prop('disabled', true).text('Updating...');

      $.ajax({
        url: `${url}api/v1/orders/${currentOrderId}/status`,
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        data: JSON.stringify({
          status: newStatus,
          notes: notes,
          notify_customer: true,
          update_type: 'status_change'
        }),
        success: function(response) {
          if (response.success) {
            Swal.fire({
              icon: 'success',
              title: 'Status Updated!',
              text: `Order status has been updated to ${newStatus}`,
              timer: 2000,
              showConfirmButton: false
            });

            bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
            ordersTable.ajax.reload(null, false);
            $('#confirmUpdateBtn').prop('disabled', false).text('Update Status');
            
            console.log(`Order ${currentOrderId} status updated to ${newStatus}`);
          } else {
            throw new Error(response.message || 'Update failed');
          }
        },
        error: function(xhr) {
          console.error('Error updating status:', xhr);
          const errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.message || 'Failed to update order status';
          
          Swal.fire({
            icon: 'error',
            title: 'Update Failed',
            text: errorMsg,
            confirmButtonColor: '#4ade80'
          });
          
          $('#confirmUpdateBtn').prop('disabled', false).text('Update Status');
        }
      });
    }

    function updateStats(orders) {
      const total = orders.length;
      let pending = 0;
      let shipped = 0;
      let completed = 0;

      orders.forEach(order => {
        if (order.status === 'pending') pending++;
        if (order.status === 'shipped') shipped++;
        if (order.status === 'received') completed++;
      });

      $('#totalOrders').text(total);
      $('#pendingOrders').text(pending);
      $('#shippedOrders').text(shipped);
      $('#completedOrders').text(completed);
    }
  </script>
</body>
</html>