<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniTree - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <link rel="stylesheet" href="css/products.css">
</head>
<body>
    <div id="header"></div> 
   
    <script>
        $('#header').load('header.html');
    </script>

    <div class="container">
        <div class="page-header">
            <h1>Welcome to UniTree</h1>
            <p>University's largest marketplace for accessible products and interactive experience</p>
        </div>

        <div class="filter-bar">
            <select id="categoryFilter">
                <option value="">All Categories</option>
            </select>
            <span class="product-count"><span id="productCount">0</span> Products</span>
        </div>

        <div class="product-grid" id="productGrid">
            <div class="loading">Loading products...</div>
        </div>
    </div>

    <div id="footer"></div> 
   
    <script>
        $('#footer').load('footer.html');
    </script>
    
<script>
const API_BASE = '/api/v1';
let allProducts = [];    
let categories = [];     

function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

// Search products
function searchProducts() {
    const query = $('#searchInput').val().toLowerCase();
    if (!query) {
        filterProducts(); 
        return;
    }
    
    const filtered = allProducts.filter(product => 
        product.name.toLowerCase().includes(query) || 
        (product.description && product.description.toLowerCase().includes(query))
    );
    displayProducts(filtered);
}

$(document).ready(function() {
    loadCategories();
    
    $.when($.ready).then(function() {
        loadProducts().then(function() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('category');
            if (categoryId) {
                $('#categoryFilter').val(categoryId);
                filterProducts();  
            }
        });
    });
    
    $('#categoryFilter').on('change', function() {
        const categoryId = $(this).val();
        const url = new URL(window.location);
        categoryId ? url.searchParams.set('category', categoryId) : url.searchParams.delete('category');
        window.history.pushState({}, '', url);
        filterProducts();
    });
    
    $('#searchInput').on('input', debounce(searchProducts, 500));
});

// filter products
function filterProducts() {
    const categoryId = $('#categoryFilter').val();
    if (!categoryId) {
        displayProducts(allProducts);
        return;
    }
    displayProducts(allProducts.filter(product => product.category_id == categoryId));
}

// categories
function loadCategories() {
    $.get(`${API_BASE}/categories`)
        .done(function(res) {
            if (res.categories?.length) {
                categories = res.categories;
                const $select = $('#categoryFilter').empty().append('<option value="">All Categories</option>');
                res.categories.forEach(cat => $select.append(`<option value="${cat.category_id}">${cat.name}</option>`));
                
                const categoryId = new URLSearchParams(window.location.search).get('category');
                if (categoryId) {
                    $select.val(categoryId);
                    filterProducts();
                }
            }
        })
        .fail(console.error);
}
//products
function loadProducts() {
    return new Promise((resolve, reject) => {
        $('#productGrid').html('<div class="loading">Loading products...</div>');
        
        $.get(`${API_BASE}/products`)
            .done(function(res) {
                if (res.data?.length) {
                    allProducts = res.data;
                    displayProducts(allProducts);
                } else {
                    $('#productGrid').html('<div class="empty">No products found</div>');
                }
                resolve();
            })
            .fail(function(err) {
                console.error('Failed to load products:', err);
                $('#productGrid').html('<div class="error">Failed to load products. Please try again.</div>');
                reject(err);
            });
    });
}

// Display products
function displayProducts(products) {
    if (!products || products.length === 0) {
        $('#productGrid').html('<div class="empty">No products found</div>');
        $('#productCount').text('0');
        return;
    }
    
    $('#productCount').text(products.length);
    
    let html = '';
    products.forEach(product => {
        let imageUrl = '';
        if (Array.isArray(product.images) && product.images.length > 0) {
            imageUrl = product.images[0];
        } else if (product.image_path) {
            imageUrl = product.image_path;
        } else if (product.image) {
            imageUrl = product.image;
        } else {
            imageUrl = 'images/noimg.jpg';
        }

        if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('data:image')) {
            imageUrl = imageUrl.startsWith('/') ? imageUrl : `/${imageUrl}`;
        }

        const price = parseFloat(product.price).toFixed(2);
        const stock = product.stock || 0;
        const inStock = stock > 0;
        
        html += `
            <div class="product-card-container" data-id="${product.product_id}">
                <a href="product-details.html?id=${product.product_id}" class="product-card-link">
                    <div class="product-card">
                        <img src="${imageUrl}" alt="${product.name}" class="product-image" 
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/320x320/667eea/ffffff?text=Image+Not+Available'">
                        <div class="product-info">
                            <h3 class="product-name">${product.name}</h3>
                            <p class="product-description">${product.description ? product.description.substring(0, 100) + '...' : ''}</p>
                            <div class="product-price">â‚±${price}</div>
                        </div>
                    </div>
                </a>
                ${inStock ? `
                    <div class="product-actions">
                        <button class="btn-add-cart" data-id="${product.product_id}" data-name="${product.name}" data-price="${price}" data-image="${imageUrl}">
                            <i class="fas fa-cart-plus"></i>
                            <span>Add to Cart</span>
                        </button>
                        <button class="btn-buy-now" data-id="${product.product_id}" data-name="${product.name}" data-price="${price}" data-image="${imageUrl}">
                            <i class="fas fa-bolt"></i>
                            <span>Buy Now</span>
                        </button>
                    </div>
                ` : '<div class="out-of-stock-badge">Out of Stock</div>'}
            </div>
        `;
    });
    
    $('#productGrid').html(html);
    updateCartCount();
}

$(document).ready(function() {
    updateCartCount();
    
    $(document).on('click', '.product-card', function(e) {
        if ($(e.target).closest('button, a, .btn-add-cart, .btn-buy-now').length) {
            return;
        }
        window.location.href = $(this).closest('.product-card-link').attr('href');
    });
});
</script>

<script src="js/cart.js"></script>
<script src="js/user.js"></script>
</body>
</html>